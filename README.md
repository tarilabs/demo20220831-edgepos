# demo20220831-edgepos Project

This project uses Quarkus, the Supersonic Subatomic Java Framework.

If you want to learn more about Quarkus, please visit its website: https://quarkus.io/ .
The GUI embedded in this repo is coming from this sibling project: https://github.com/tarilabs/demo20220831-edgepos-ui

## Notes

used https://code.quarkus.redhat.com/?g=org.drools.hackfest2022&a=demo20220831-edgepos&e=resteasy-jackson&e=smallrye-openapi&e=kubernetes&e=container-image-jib&e=org.kie.kogito%3Akogito-quarkus-rules&extension-search=origin:platform%20DRL

pushing to Quay.io with

```
mvn clean install install -Dquarkus.container-image.push=true
```

## Quick start

Install podman and ensure date(time) is setup correctly:

**Fedora**:

typically Podman is already installed, in case:

```sh
sudo dnf install podman
date
```

**Debian-based**:

```sh
sudo apt-get install podman
date
```

**Launch application**:

Then, launch this Drools+Quarkus application from a container image from quay.io registry

```sh
podman pull quay.io/mmortari/demo20220831-edgepos:1.0.0-SNAPSHOT
podman run -i --rm -p 8080:8080 quay.io/mmortari/demo20220831-edgepos:1.0.0-SNAPSHOT
```

## Configuring a Fedora box:

- checked `hostname`
- checked `sudo systemctl status avahi-daemon.service` to be enabled (so box to be reachable via `fedora.local` remotely)
- Settings auto login for my user enabled
- Settings of 1 workspace only
- used also https://extensions.gnome.org/extension/4099/no-overview/

## Configuring podman and systemd (manually)

```sh
sudo systemctl enable podman-auto-update.service

podman run --name app1 -d --label "io.containers.autoupdate=registry" --rm -p 8080:8080 quay.io/mmortari/demo20220831-edgepos:1.0.0-SNAPSHOT
podman generate systemd --new app1 -n > ~/.config/systemd/user/app1.service
systemctl --user daemon-reload
systemctl --user enable app1.service
systemctl --user start app1.service
systemctl --user status app1.service
```

## Systemd files

`~/.config/systemd/user/app1.service`:

```
# container-app1.service
# autogenerated by Podman 4.3.1
# Thu Feb  9 18:48:26 CET 2023

[Unit]
Description=Podman container-app1.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStartPre=/bin/rm \
	-f %t/%n.ctr-id
ExecStart=/usr/bin/podman run \
	--cidfile=%t/%n.ctr-id \
	--cgroups=no-conmon \
	--rm \
	--sdnotify=conmon \
	--replace \
	--name app1 \
	-d \
	--label io.containers.autoupdate=registry \
	-p 8080:8080 quay.io/mmortari/demo20220831-edgepos:1.0.0-SNAPSHOT
ExecStop=/usr/bin/podman stop \
	--ignore -t 10 \
	--cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm \
	-f \
	--ignore -t 10 \
	--cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target
```

also,

`~/.config/systemd/user/gui.service`:

```
[Unit]
Description=Service running firefox
After=network.target app1.service

[Service]
Type=simple
Environment="DISPLAY=:0"
ExecStart=/usr/bin/firefox --kiosk http://localhost:8080
Restart=on-failure
RestartSec=1
TimeoutSec=60
RuntimeMaxSec=infinity

[Install]
WantedBy=default.target
```

## Ansible

Using Ansible as an alternative, to automatically configure the edge pos boxes.

Ensure on the controller machine there is an host file inside `inventory/`, something ~like:

```
fedora.local ansible_ssh_user=your_ssh_user_here
```

Especially on Mac OSX, to avoid the need of `sshpass` on the controller, simply copy pub key to the host(s), for example via

```sh
ssh-copy-id -i $HOME/.ssh/id_rsa.pub your_ssh_user_here@fedora.local
```

Update and Configure devices using Ansible:

```sh
ansible all --list-hosts -i inventory
ansible all -i inventory -m ping
ansible-playbook -i inventory --ask-become-pass playbook_prereq.yml
ansible-playbook -i inventory playbook.yml
```

![](Screenshot%202023-02-22%20at%2014.37.08.png)

<!--
## Running the application in dev mode

You can run your application in dev mode that enables live coding using:
```shell script
./mvnw compile quarkus:dev
```

> **_NOTE:_**  Quarkus now ships with a Dev UI, which is available in dev mode only at http://localhost:8080/q/dev/.

## Packaging and running the application

The application can be packaged using:
```shell script
./mvnw package
```
It produces the `quarkus-run.jar` file in the `target/quarkus-app/` directory.
Be aware that it’s not an _über-jar_ as the dependencies are copied into the `target/quarkus-app/lib/` directory.

The application is now runnable using `java -jar target/quarkus-app/quarkus-run.jar`.

If you want to build an _über-jar_, execute the following command:
```shell script
./mvnw package -Dquarkus.package.type=uber-jar
```

The application, packaged as an _über-jar_, is now runnable using `java -jar target/*-runner.jar`.

## Creating a native executable

You can create a native executable using: 
```shell script
./mvnw package -Pnative
```

Or, if you don't have GraalVM installed, you can run the native executable build in a container using: 
```shell script
./mvnw package -Pnative -Dquarkus.native.container-build=true
```

You can then execute your native executable with: `./target/demo20220831-edgepos-1.0.0-SNAPSHOT-runner`

If you want to learn more about building native executables, please consult https://quarkus.io/guides/maven-tooling.

## Related Guides

- SmallRye OpenAPI ([guide](https://quarkus.io/guides/openapi-swaggerui)): Document your REST APIs with OpenAPI - comes with Swagger UI
- Kogito - Rules (DRL) ([guide](https://quarkus.io/guides/kogito-drl)): Add Kogito rules (DRL) capabilities - Include Drools engine
- Kubernetes ([guide](https://quarkus.io/guides/kubernetes)): Generate Kubernetes resources from annotations

## Provided Code

### RESTEasy JAX-RS

Easily start your RESTful Web Services

[Related guide section...](https://quarkus.io/guides/getting-started#the-jax-rs-resources)
-->